name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to Cloud Run'
        required: false
        default: 'false'

env:
  PROJECT_ID: genhack-heat-dev
  REGION: europe-west1
  REGISTRY_LOCATION: europe
  REGISTRY_NAME: heat
  IMAGE_NAME: gh-pipeline

jobs:
  # ===========================================
  # Security: Forbid Kura references
  # ===========================================
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan for Kura references
        run: |
          echo "ðŸ” Scanning for mental-journal-dev references..."
          
          # Search in source code (excluding docs)
          if grep -r "mental-journal-dev" src/ pipeline/ configs/ schemas/ 2>/dev/null; then
            echo "âŒ SECURITY VIOLATION: Found references to Kura project!"
            echo "   This is a clean-room duplication. Remove all Kura references."
            exit 1
          fi
          
          echo "âœ… No Kura references found in code"
      
      - name: Verify project ID
        run: |
          echo "ðŸ” Verifying PROJECT_ID..."
          
          # Check all YAML configs
          if grep -r "mental-journal-dev" configs/ 2>/dev/null; then
            echo "âŒ Found Kura project ID in configs!"
            exit 1
          fi
          
          echo "âœ… Project ID verification passed"

  # ===========================================
  # Build Docker image
  # ===========================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: security-check
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image
        run: |
          docker build \
            -f pipeline/Dockerfile.geo \
            -t ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.IMAGE_NAME }}:latest \
            --platform linux/amd64 \
            .
      
      - name: Test image
        run: |
          # Verify image can run and import key dependencies
          docker run --rm --entrypoint python ${{ env.IMAGE_NAME }}:latest \
            -c "import sys; import rasterio; import xarray; sys.exit(0)"
          
          echo "âœ… Image smoke test passed"
      
      - name: Save image artifact
        run: |
          docker save ${{ env.IMAGE_NAME }}:${{ github.sha }} | gzip > image.tar.gz
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar.gz
          retention-days: 1

  # ===========================================
  # Run tests
  # ===========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pytest jsonschema pydantic pyyaml
      
      - name: Run contract tests
        run: |
          pytest tests/test_contracts.py -v

  # ===========================================
  # Deploy (manual trigger only - disabled auto-deploy)
  # ===========================================
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [build, test]
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.deploy == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load image
        run: |
          docker load < image.tar.gz
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev
      
      - name: Tag and push image
        run: |
          IMAGE_URL="${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}"
          
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} $IMAGE_URL:${{ github.sha }}
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} $IMAGE_URL:latest
          
          docker push $IMAGE_URL:${{ github.sha }}
          docker push $IMAGE_URL:latest
      
      - name: Deploy Cloud Run Job
        run: |
          JOB_NAME="heat-downscaling-pipeline"
          IMAGE_URL="${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          SA_EMAIL="gh-pipeline-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com"
          
          if gcloud run jobs describe $JOB_NAME --region=${{ env.REGION }} &>/dev/null; then
            echo "Updating existing job..."
            gcloud run jobs update $JOB_NAME \
              --image=$IMAGE_URL \
              --region=${{ env.REGION }} \
              --service-account=$SA_EMAIL
          else
            echo "Creating new job..."
            gcloud run jobs create $JOB_NAME \
              --image=$IMAGE_URL \
              --region=${{ env.REGION }} \
              --service-account=$SA_EMAIL \
              --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }}" \
              --task-timeout=3600 \
              --max-retries=1 \
              --memory=4Gi \
              --cpu=2
          fi
          
          echo "âœ… Deployment complete!"
          echo "Execute with: gcloud run jobs execute $JOB_NAME --region=${{ env.REGION }}"
